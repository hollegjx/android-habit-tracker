<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹ æƒ¯è¿½è¸ª - ç®¡ç†åå°</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .nav {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .nav button {
            margin-right: 10px;
            padding: 8px 16px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .nav button:hover {
            background: #0056b3;
        }
        .nav button.active {
            background: #28a745;
        }
        .content {
            padding: 20px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .login-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
        .ai-character-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }
        .status-accepted {
            color: #28a745;
            font-weight: bold;
        }
        .status-declined {
            color: #dc3545;
            font-weight: bold;
        }
        .status-blocked {
            color: #6c757d;
            font-weight: bold;
        }
        .activity-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .activity-filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        .close:hover {
            color: black;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <div id="adminPanel" class="container">
        <div class="header">
            <h1>ä¹ æƒ¯è¿½è¸ª - ç®¡ç†åå°</h1>
            <p>ç³»ç»Ÿç®¡ç†ä¸ç›‘æ§é¢æ¿</p>
            <button class="btn btn-danger" onclick="logout()" style="position: absolute; top: 20px; right: 20px;">ç™»å‡º</button>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('dashboard')">ä»ªè¡¨æ¿</button>
            <button class="nav-btn" onclick="showSection('users')">ç”¨æˆ·ç®¡ç†</button>
            <button class="nav-btn" onclick="showSection('user-activities')">ç”¨æˆ·æ´»åŠ¨</button>
            <button class="nav-btn" onclick="showSection('friend-requests')">å¥½å‹ç®¡ç†</button>
            <button class="nav-btn" onclick="showSection('chat-monitoring')">èŠå¤©ç›‘æ§</button>
            <button class="nav-btn" onclick="showSection('ai-characters')">AIè§’è‰²ç®¡ç†</button>
            <button class="nav-btn" onclick="showSection('api-test')">APIæµ‹è¯•</button>
            <button class="nav-btn" onclick="showSection('system-logs')" style="background: #dc3545;">ğŸ“‹ ç³»ç»Ÿæ—¥å¿—</button>
            <button class="nav-btn" onclick="showSection('database-debug')" style="background: #6f42c1;">ğŸ—„ï¸ æ•°æ®åº“è°ƒè¯•</button>
            <button class="nav-btn" onclick="window.open('/ai-chat.html', '_blank')" style="background: #28a745;">ğŸ¤– AIèŠå¤©</button>
            <button class="nav-btn" onclick="window.open('/admin-debug.html', '_blank')" style="background: #17a2b8;">ğŸ” è°ƒè¯•é¢æ¿</button>
            <button class="nav-btn" onclick="window.open('/admin-perf-test.html', '_blank')" style="background: #ffc107; color: #000;">âš¡ æ€§èƒ½æµ‹è¯•</button>
        </div>

        <div class="content">
            <!-- ä»ªè¡¨æ¿ -->
            <div id="dashboard" class="section active">
                <h2>ç³»ç»Ÿæ¦‚è§ˆ</h2>
                <div id="statsContainer" class="stats-grid">
                    <!-- ç»Ÿè®¡æ•°æ®å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- ç”¨æˆ·ç®¡ç† -->
            <div id="users" class="section">
                <h2>ç”¨æˆ·ç®¡ç†</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                    <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·ï¼ˆç”¨æˆ·åã€é‚®ç®±ã€UIDï¼‰" onkeyup="searchUsers()" style="max-width: 300px;">
                    <button class="btn btn-success" onclick="showCreateUserModal()">åˆ›å»ºç”¨æˆ·</button>
                    <button class="btn btn-primary" onclick="loadUsers()">åˆ·æ–°</button>
                </div>
                <div id="usersContainer">
                    <!-- ç”¨æˆ·åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- ç”¨æˆ·æ´»åŠ¨ -->
            <div id="user-activities" class="section">
                <h2>ç”¨æˆ·æ´»åŠ¨ç›‘æ§</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="activityTypeFilter" onchange="loadUserActivities()">
                        <option value="all">æ‰€æœ‰æ´»åŠ¨</option>
                        <option value="login">ç™»å½•æ´»åŠ¨</option>
                        <option value="friendship">å¥½å‹æ´»åŠ¨</option>
                        <option value="message">æ¶ˆæ¯æ´»åŠ¨</option>
                    </select>
                    <select id="activityDaysFilter" onchange="loadUserActivities()">
                        <option value="7">æœ€è¿‘7å¤©</option>
                        <option value="30">æœ€è¿‘30å¤©</option>
                        <option value="90">æœ€è¿‘90å¤©</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadUserActivities()">åˆ·æ–°</button>
                </div>
                <div id="userActivitiesContainer">
                    <!-- ç”¨æˆ·æ´»åŠ¨åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- å¥½å‹ç®¡ç† -->
            <div id="friend-requests" class="section">
                <h2>å¥½å‹è¯·æ±‚ç®¡ç†</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="friendStatusFilter" onchange="loadFriendRequests()">
                        <option value="all">å…¨éƒ¨çŠ¶æ€</option>
                        <option value="pending">å¾…å¤„ç†</option>
                        <option value="accepted">å·²æ¥å—</option>
                        <option value="declined">å·²æ‹’ç»</option>
                        <option value="blocked">å·²å±è”½</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadFriendRequests()">åˆ·æ–°</button>
                </div>
                <div id="friendRequestsContainer">
                    <!-- å¥½å‹è¯·æ±‚åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- èŠå¤©ç›‘æ§ -->
            <div id="chat-monitoring" class="section">
                <h2>èŠå¤©æ¶ˆæ¯ç›‘æ§</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="chatTypeFilter" onchange="loadChatMessages()">
                        <option value="all">æ‰€æœ‰æ¶ˆæ¯</option>
                        <option value="private">ç§èŠ</option>
                        <option value="group">ç¾¤èŠ</option>
                        <option value="ai">AIèŠå¤©</option>
                    </select>
                    <select id="chatDaysFilter" onchange="loadChatMessages()">
                        <option value="7">æœ€è¿‘7å¤©</option>
                        <option value="30">æœ€è¿‘30å¤©</option>
                        <option value="90">æœ€è¿‘90å¤©</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadChatMessages()">åˆ·æ–°</button>
                </div>
                <div id="chatMonitoringContainer">
                    <!-- èŠå¤©æ¶ˆæ¯åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- AIè§’è‰²ç®¡ç† -->
            <div id="ai-characters" class="section">
                <h2>AIè§’è‰²ç®¡ç†</h2>
                
                <div class="ai-character-form">
                    <h3>åˆ›å»ºæ–°AIè§’è‰²</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>è§’è‰²åç§°:</label>
                            <input type="text" id="characterName" placeholder="ä¾‹å¦‚ï¼šå­¦ä¹ åŠ©æ‰‹">
                        </div>
                        <div class="form-group">
                            <label>AIæ¨¡å‹:</label>
                            <select id="characterModel">
                                <option value="gpt-4.1">GPT-4.1 (æ¨è)</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>è§’è‰²æè¿°:</label>
                        <input type="text" id="characterDescription" placeholder="ç®€çŸ­æè¿°è¿™ä¸ªAIè§’è‰²çš„ç”¨é€”">
                    </div>
                    <div class="form-group">
                        <label>è§’è‰²æ€§æ ¼:</label>
                        <input type="text" id="characterPersonality" placeholder="ä¾‹å¦‚ï¼šå‹å–„ã€ä¸“ä¸šã€è€å¿ƒ">
                    </div>
                    <div class="form-group">
                        <label>ç³»ç»Ÿæç¤ºè¯:</label>
                        <textarea id="characterSystemPrompt" rows="4" placeholder="è¯¦ç»†æè¿°AIè§’è‰²çš„è¡Œä¸ºå’Œå›åº”æ–¹å¼..."></textarea>
                    </div>
                    <button class="btn btn-success" onclick="createAICharacter()">åˆ›å»ºè§’è‰²</button>
                </div>

                <div id="aiCharactersContainer">
                    <!-- AIè§’è‰²åˆ—è¡¨å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>

            <!-- APIæµ‹è¯• -->
            <div id="api-test" class="section">
                <h2>APIæµ‹è¯•å·¥å…·</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>æµ‹è¯•ç”¨æˆ·æ³¨å†Œ</h3>
                        <div class="form-group">
                            <label>ç”¨æˆ·å:</label>
                            <input type="text" id="testUsername" value="testuser">
                        </div>
                        <div class="form-group">
                            <label>é‚®ç®±:</label>
                            <input type="email" id="testEmail" value="test@example.com">
                        </div>
                        <div class="form-group">
                            <label>å¯†ç :</label>
                            <input type="password" id="testPassword" value="password123">
                        </div>
                        <div class="form-group">
                            <label>æ˜µç§°:</label>
                            <input type="text" id="testNickname" value="æµ‹è¯•ç”¨æˆ·">
                        </div>
                        <button class="btn btn-primary" onclick="testRegister()">æµ‹è¯•æ³¨å†Œ</button>
                    </div>
                    <div>
                        <h3>æµ‹è¯•AIèŠå¤©</h3>
                        <div class="form-group">
                            <label>é€‰æ‹©AIè§’è‰²:</label>
                            <select id="testAICharacter">
                                <!-- AIè§’è‰²é€‰é¡¹å°†åŠ¨æ€åŠ è½½ -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>æµ‹è¯•æ¶ˆæ¯:</label>
                            <textarea id="testMessage" rows="3">ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è‡ªå·±</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="testAIChat()">å‘é€æ¶ˆæ¯</button>
                    </div>
                </div>
                <div id="testResults" style="margin-top: 20px;">
                    <!-- æµ‹è¯•ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡† -->
    <div id="createUserModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="hideCreateUserModal()">&times;</span>
            <h2>åˆ›å»ºæ–°ç”¨æˆ·</h2>
            <form id="createUserForm" style="max-width: 400px;">
                <div class="form-group">
                    <label>ç”¨æˆ·å *</label>
                    <input type="text" id="newUsername" required placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label>é‚®ç®± *</label>
                    <input type="email" id="newEmail" required placeholder="è¯·è¾“å…¥é‚®ç®±">
                </div>
                <div class="form-group">
                    <label>å¯†ç  *</label>
                    <input type="password" id="newPassword" required placeholder="è¯·è¾“å…¥å¯†ç ">
                </div>
                <div class="form-group">
                    <label>æ˜µç§°</label>
                    <input type="text" id="newNickname" placeholder="è¯·è¾“å…¥æ˜µç§°">
                </div>
                <div class="form-group">
                    <label>è§’è‰²</label>
                    <select id="newRole">
                        <option value="user">æ™®é€šç”¨æˆ·</option>
                        <option value="admin">ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateUserModal()">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">åˆ›å»ºç”¨æˆ·</button>
                </div>
            </form>
            <!-- ç³»ç»Ÿæ—¥å¿—ç®¡ç† -->
            <div id="system-logs" class="section">
                <h2>ç³»ç»Ÿæ—¥å¿—ç®¡ç†</h2>
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <label>æ—¥å¿—çº§åˆ«:</label>
                        <select id="logLevelFilter" style="padding: 5px;">
                            <option value="">å…¨éƒ¨</option>
                            <option value="ERROR">é”™è¯¯</option>
                            <option value="WARN">è­¦å‘Š</option>
                            <option value="INFO">ä¿¡æ¯</option>
                            <option value="DEBUG">è°ƒè¯•</option>
                        </select>
                        
                        <label>åˆ†ç±»:</label>
                        <select id="logCategoryFilter" style="padding: 5px;">
                            <option value="">å…¨éƒ¨</option>
                            <option value="USER_SEARCH">ç”¨æˆ·æœç´¢</option>
                            <option value="ADMIN_LOGS">ç®¡ç†å‘˜æ—¥å¿—</option>
                            <option value="ADMIN_DEBUG">è°ƒè¯•ä¿¡æ¯</option>
                            <option value="SYSTEM">ç³»ç»Ÿ</option>
                        </select>
                        
                        <label>æœç´¢:</label>
                        <input type="text" id="logSearchInput" placeholder="æœç´¢æ—¥å¿—å†…å®¹..." style="padding: 5px; width: 200px;">
                        
                        <button class="btn btn-primary" onclick="loadSystemLogs()">åˆ·æ–°æ—¥å¿—</button>
                        <button class="btn btn-warning" onclick="clearMemoryLogs()">æ¸…ç©ºå†…å­˜æ—¥å¿—</button>
                    </div>
                </div>
                
                <div id="logStats" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <!-- æ—¥å¿—ç»Ÿè®¡ä¿¡æ¯å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
                
                <div id="systemLogsContainer" style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #000; color: #fff; font-family: 'Courier New', monospace; font-size: 12px;">
                    <div style="color: #888;">æ­£åœ¨åŠ è½½ç³»ç»Ÿæ—¥å¿—...</div>
                </div>
            </div>

            <!-- æ•°æ®åº“è°ƒè¯•ä¿¡æ¯ -->
            <div id="database-debug" class="section">
                <h2>æ•°æ®åº“è°ƒè¯•ä¿¡æ¯</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadDatabaseDebugInfo()">è·å–æ•°æ®åº“ä¿¡æ¯</button>
                    <button class="btn btn-info" onclick="refreshDatabaseDebugInfo()">åˆ·æ–°</button>
                </div>
                
                <div id="databaseDebugContainer">
                    <div style="color: #888;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®è·å–æ•°æ®åº“è°ƒè¯•ä¿¡æ¯...</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ç™»å½•çŠ¶æ€æ£€æŸ¥ - é¡µé¢åŠ è½½æ—¶ç«‹å³æ‰§è¡Œ
        (function() {
            const token = localStorage.getItem('adminToken');
            const user = localStorage.getItem('adminUser');
            
            if (!token || !user) {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = '/';
                return;
            }
            
            try {
                const userData = JSON.parse(user);
                if (userData.role !== 'admin') {
                    // ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ¸…é™¤æ•°æ®å¹¶è·³è½¬
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminRefreshToken');
                    localStorage.removeItem('adminUser');
                    window.location.href = '/';
                    return;
                }
            } catch (e) {
                // æ•°æ®æ— æ•ˆï¼Œæ¸…é™¤å¹¶è·³è½¬
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminRefreshToken');
                localStorage.removeItem('adminUser');
                window.location.href = '/';
                return;
            }
        })();

        // ä½¿ç”¨å½“å‰åè®®ï¼ˆæ”¯æŒHTTPå’ŒHTTPSï¼‰
        const API_BASE = window.location.origin + '/api';
        
        console.log('APIåœ°å€:', API_BASE);
        let accessToken = localStorage.getItem('adminToken');

        // é€šç”¨APIè°ƒç”¨å‡½æ•°
        async function apiCall(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(accessToken && { 'Authorization': `Bearer ${accessToken}` })
                }
            };
            
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            };
            
            console.log('APIè°ƒç”¨:', url, 'Token:', accessToken ? accessToken.substring(0, 20) + '...' : 'null');
            
            const response = await fetch(url, finalOptions);
            
            if (!response.ok) {
                if (response.status === 401) {
                    console.error('è®¤è¯å¤±è´¥ï¼Œé‡æ–°ç™»å½•');
                    logout();
                    throw new Error('è®¤è¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å’Œç»‘å®šäº‹ä»¶
        window.onload = function() {
            // å…ˆæ£€æŸ¥APIè¿æ¥
            checkAPIConnection();
            
            // ç›´æ¥æ˜¾ç¤ºç®¡ç†é¢æ¿ï¼ˆç™»å½•æ£€æŸ¥å·²åœ¨é¡µé¢å¼€å¤´å®Œæˆï¼‰
            showAdminPanel();
            
            // æ·»åŠ è¡¨å•äº‹ä»¶ç›‘å¬å™¨
            document.getElementById('createUserForm').addEventListener('submit', createUser);
        };

        // æ£€æŸ¥APIè¿æ¥
        async function checkAPIConnection() {
            try {
                const healthUrl = window.location.origin + '/health';
                console.log('æ£€æŸ¥APIè¿æ¥:', healthUrl);
                
                const response = await fetch(healthUrl);
                if (response.ok) {
                    const data = await response.json();
                    console.log('âœ… APIè¿æ¥æˆåŠŸ:', data);
                } else {
                    console.error('âŒ APIè¿æ¥å¤±è´¥:', response.status);
                    showError('loginError', `APIæœåŠ¡å™¨å“åº”é”™è¯¯: ${response.status}`);
                }
            } catch (error) {
                console.error('âŒ APIè¿æ¥æ£€æŸ¥å¤±è´¥:', error);
                showError('loginError', 'APIæœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
            }
        }



        // ç™»å‡ºå‡½æ•°
        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminRefreshToken');
            localStorage.removeItem('adminUser');
            accessToken = null;
            window.location.href = '/';
        }

        // æ˜¾ç¤ºç®¡ç†é¢æ¿
        function showAdminPanel() {
            // ç®¡ç†é¢æ¿å·²ç»å¯è§ï¼Œç›´æ¥åŠ è½½æ•°æ®
            loadDashboard();
        }

        // åˆ‡æ¢é¡µé¢
        function showSection(sectionName) {
            // éšè—æ‰€æœ‰section
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // æ˜¾ç¤ºé€‰ä¸­çš„section
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'user-activities':
                    loadUserActivities();
                    break;
                case 'friend-requests':
                    loadFriendRequests();
                    break;
                case 'chat-monitoring':
                    loadChatMessages();
                    break;
                case 'ai-characters':
                    loadAICharacters();
                    break;
                case 'api-test':
                    loadAICharactersForTest();
                    break;
            }
        }

        // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const stats = data.data;
                    const container = document.getElementById('statsContainer');
                    container.innerHTML = `
                        <div class="stat-card">
                            <h3>æ€»ç”¨æˆ·æ•°</h3>
                            <div class="number">${stats.users.total_users}</div>
                        </div>
                        <div class="stat-card">
                            <h3>æ´»è·ƒç”¨æˆ·</h3>
                            <div class="number">${stats.users.active_users}</div>
                        </div>
                        <div class="stat-card">
                            <h3>æœ¬å‘¨æ–°ç”¨æˆ·</h3>
                            <div class="number">${stats.users.new_users_week}</div>
                        </div>
                        <div class="stat-card">
                            <h3>ä»Šæ—¥ç™»å½•</h3>
                            <div class="number">${stats.users.logins_today || 0}</div>
                        </div>
                        <div class="stat-card">
                            <h3>æ€»æ¶ˆæ¯æ•°</h3>
                            <div class="number">${stats.messages.total_messages}</div>
                        </div>
                        <div class="stat-card">
                            <h3>ä»Šæ—¥æ¶ˆæ¯</h3>
                            <div class="number">${stats.messages.messages_today}</div>
                        </div>
                        <div class="stat-card">
                            <h3>å¾…å¤„ç†å¥½å‹è¯·æ±‚</h3>
                            <div class="number">${stats.friendRequests?.pending || 0}</div>
                        </div>
                        <div class="stat-card">
                            <h3>AIè§’è‰²æ•°</h3>
                            <div class="number">${stats.aiCharacters.active_characters}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
            }
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers() {
            try {
                const data = await apiCall(`${API_BASE}/admin/users`);

                if (data.success) {
                    const container = document.getElementById('usersContainer');
                    const users = data.data.users;
                    
                    container.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>UID</th>
                                    <th>ç”¨æˆ·å</th>
                                    <th>é‚®ç®±</th>
                                    <th>æ˜µç§°</th>
                                    <th>è§’è‰²</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ³¨å†Œæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td>${user.uid}</td>
                                        <td>${user.username}</td>
                                        <td>${user.email}</td>
                                        <td>${user.nickname || '-'}</td>
                                        <td>${user.role}</td>
                                        <td>${user.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</td>
                                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <button class="btn ${user.is_active ? 'btn-danger' : 'btn-success'}" 
                                                    onclick="toggleUserStatus(${user.id}, ${!user.is_active})">
                                                ${user.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æœç´¢ç”¨æˆ·
        async function searchUsers() {
            const search = document.getElementById('userSearch').value;
            if (search.length < 2) return;

            try {
                const response = await fetch(`${API_BASE}/admin/users?search=${encodeURIComponent(search)}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    // æ›´æ–°ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤º
                    loadUsers();
                }
            } catch (error) {
                console.error('æœç´¢ç”¨æˆ·å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        async function toggleUserStatus(userId, isActive) {
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive })
                });

                const data = await response.json();
                if (data.success) {
                    loadUsers(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                }
            } catch (error) {
                console.error('æ›´æ–°ç”¨æˆ·çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // æ˜¾ç¤ºåˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡†
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'flex';
        }

        // éšè—åˆ›å»ºç”¨æˆ·æ¨¡æ€æ¡†
        function hideCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
            document.getElementById('createUserForm').reset();
        }

        // åˆ›å»ºç”¨æˆ·
        async function createUser(event) {
            event.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const nickname = document.getElementById('newNickname').value;
            const role = document.getElementById('newRole').value;

            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        nickname: nickname || username,
                        role
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('ç”¨æˆ·åˆ›å»ºæˆåŠŸï¼');
                    hideCreateUserModal();
                    loadUsers(); // é‡æ–°åŠ è½½ç”¨æˆ·åˆ—è¡¨
                } else {
                    alert('åˆ›å»ºå¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                console.error('åˆ›å»ºç”¨æˆ·å¤±è´¥:', error);
                alert('åˆ›å»ºç”¨æˆ·å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // åŠ è½½AIè§’è‰²
        async function loadAICharacters() {
            try {
                const response = await fetch(`${API_BASE}/ai-characters/admin/all`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('aiCharactersContainer');
                    const characters = data.data;
                    
                    container.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>åç§°</th>
                                    <th>æè¿°</th>
                                    <th>æ¨¡å‹</th>
                                    <th>çŠ¶æ€</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${characters.map(char => `
                                    <tr>
                                        <td>${char.name}</td>
                                        <td>${char.description || '-'}</td>
                                        <td>${char.model}</td>
                                        <td>${char.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨'}</td>
                                        <td>${new Date(char.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <button class="btn btn-primary" 
                                                    onclick="editAICharacter('${char.character_id}')">
                                                ç¼–è¾‘
                                            </button>
                                            <button class="btn ${char.is_active ? 'btn-danger' : 'btn-success'}" 
                                                    onclick="toggleCharacterStatus('${char.character_id}', ${!char.is_active})">
                                                ${char.is_active ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½AIè§’è‰²å¤±è´¥:', error);
            }
        }

        // åˆ›å»ºAIè§’è‰²
        async function createAICharacter() {
            const characterData = {
                name: document.getElementById('characterName').value,
                description: document.getElementById('characterDescription').value,
                personality: document.getElementById('characterPersonality').value,
                systemPrompt: document.getElementById('characterSystemPrompt').value,
                model: document.getElementById('characterModel').value
            };

            try {
                const response = await fetch(`${API_BASE}/ai-characters`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(characterData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('AIè§’è‰²åˆ›å»ºæˆåŠŸï¼');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('characterName').value = '';
                    document.getElementById('characterDescription').value = '';
                    document.getElementById('characterPersonality').value = '';
                    document.getElementById('characterSystemPrompt').value = '';
                    // é‡æ–°åŠ è½½åˆ—è¡¨
                    loadAICharacters();
                } else {
                    alert('åˆ›å»ºå¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                alert('åˆ›å»ºå¤±è´¥ï¼š' + error.message);
            }
        }

        // ç¼–è¾‘AIè§’è‰²
        async function editAICharacter(characterId) {
            try {
                // è·å–è§’è‰²è¯¦æƒ…
                const response = await fetch(`${API_BASE}/ai-characters/admin/${characterId}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const char = data.data;
                    
                    // å¡«å……è¡¨å•
                    document.getElementById('characterName').value = char.name;
                    document.getElementById('characterDescription').value = char.description || '';
                    document.getElementById('characterPersonality').value = char.personality || '';
                    document.getElementById('characterSystemPrompt').value = char.system_prompt || '';
                    document.getElementById('characterModel').value = char.model;

                    // ä¿®æ”¹æŒ‰é’®æ–‡æœ¬å’Œè¡Œä¸º
                    const createBtn = document.querySelector('.ai-character-form button');
                    createBtn.textContent = 'æ›´æ–°è§’è‰²';
                    createBtn.setAttribute('onclick', `updateAICharacter('${characterId}')`);
                }
            } catch (error) {
                console.error('è·å–AIè§’è‰²è¯¦æƒ…å¤±è´¥:', error);
                alert('è·å–è§’è‰²ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°AIè§’è‰²
        async function updateAICharacter(characterId) {
            const characterData = {
                name: document.getElementById('characterName').value,
                description: document.getElementById('characterDescription').value,
                personality: document.getElementById('characterPersonality').value,
                systemPrompt: document.getElementById('characterSystemPrompt').value,
                model: document.getElementById('characterModel').value
            };

            try {
                const response = await fetch(`${API_BASE}/ai-characters/${characterId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(characterData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('AIè§’è‰²æ›´æ–°æˆåŠŸï¼');
                    // é‡ç½®è¡¨å•
                    resetCharacterForm();
                    // é‡æ–°åŠ è½½åˆ—è¡¨
                    loadAICharacters();
                } else {
                    alert('æ›´æ–°å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                alert('æ›´æ–°å¤±è´¥ï¼š' + error.message);
            }
        }

        // é‡ç½®è§’è‰²è¡¨å•
        function resetCharacterForm() {
            document.getElementById('characterName').value = '';
            document.getElementById('characterDescription').value = '';
            document.getElementById('characterPersonality').value = '';
            document.getElementById('characterSystemPrompt').value = '';
            document.getElementById('characterModel').value = 'gpt-4.1';
            
            // é‡ç½®æŒ‰é’®
            const createBtn = document.querySelector('.ai-character-form button');
            createBtn.textContent = 'åˆ›å»ºè§’è‰²';
            createBtn.setAttribute('onclick', 'createAICharacter()');
        }

        // åˆ‡æ¢AIè§’è‰²çŠ¶æ€
        async function toggleCharacterStatus(characterId, isActive) {
            try {
                const response = await fetch(`${API_BASE}/ai-characters/${characterId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive })
                });

                const data = await response.json();
                if (data.success) {
                    loadAICharacters();
                }
            } catch (error) {
                console.error('æ›´æ–°AIè§’è‰²çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // ä¸ºæµ‹è¯•åŠ è½½AIè§’è‰²
        async function loadAICharactersForTest() {
            try {
                const response = await fetch(`${API_BASE}/ai-characters`);
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('testAICharacter');
                    select.innerHTML = data.data.map(char => 
                        `<option value="${char.character_id}">${char.name}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('åŠ è½½AIè§’è‰²å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•ç”¨æˆ·æ³¨å†Œ
        async function testRegister() {
            const userData = {
                username: document.getElementById('testUsername').value,
                email: document.getElementById('testEmail').value,
                password: document.getElementById('testPassword').value,
                confirmPassword: document.getElementById('testPassword').value,
                nickname: document.getElementById('testNickname').value
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                showTestResult('æ³¨å†Œæµ‹è¯•', data);
            } catch (error) {
                showTestResult('æ³¨å†Œæµ‹è¯•', { success: false, message: error.message });
            }
        }

        // æµ‹è¯•AIèŠå¤©
        async function testAIChat() {
            const characterId = document.getElementById('testAICharacter').value;
            const message = document.getElementById('testMessage').value;

            try {
                const response = await fetch(`${API_BASE}/chat/ai/chat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ characterId, message })
                });

                const data = await response.json();
                showTestResult('AIèŠå¤©æµ‹è¯•', data);
            } catch (error) {
                showTestResult('AIèŠå¤©æµ‹è¯•', { success: false, message: error.message });
            }
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function showTestResult(testName, result) {
            const container = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `alert ${result.success ? 'alert-success' : 'alert-error'}`;
            div.innerHTML = `
                <h4>${testName}</h4>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
            container.appendChild(div);
        }

        // åŠ è½½ç”¨æˆ·æ´»åŠ¨æ•°æ®
        async function loadUserActivities() {
            const activityType = document.getElementById('activityTypeFilter').value;
            const days = document.getElementById('activityDaysFilter').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/user-activity-logs?activityType=${activityType}&days=${days}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('userActivitiesContainer');
                    const activities = data.data.activities;
                    const stats = data.data.stats;
                    
                    container.innerHTML = `
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <h3>ç™»å½•æ´»åŠ¨</h3>
                                <div class="number">${stats.login || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>å¥½å‹æ´»åŠ¨</h3>
                                <div class="number">${stats.friendship || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>æ¶ˆæ¯æ´»åŠ¨</h3>
                                <div class="number">${stats.message || 0}</div>
                            </div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>ç”¨æˆ·</th>
                                    <th>æ´»åŠ¨ç±»å‹</th>
                                    <th>è¯¦æƒ…</th>
                                    <th>IPåœ°å€</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${activities.map(activity => `
                                    <tr>
                                        <td>${new Date(activity.created_at).toLocaleString()}</td>
                                        <td>${activity.username || activity.nickname || activity.uid}</td>
                                        <td>${getActivityTypeText(activity.activity_type)}</td>
                                        <td>${activity.activity_details}</td>
                                        <td>${activity.ip_address || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·æ´»åŠ¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½å¥½å‹è¯·æ±‚æ•°æ®
        async function loadFriendRequests() {
            const status = document.getElementById('friendStatusFilter').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/friend-requests?status=${status}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('friendRequestsContainer');
                    const friendRequests = data.data.friendRequests;
                    const stats = data.data.stats;
                    
                    container.innerHTML = `
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <h3>å¾…å¤„ç†</h3>
                                <div class="number">${stats.pending || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>å·²æ¥å—</h3>
                                <div class="number">${stats.accepted || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>å·²æ‹’ç»</h3>
                                <div class="number">${stats.declined || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>å·²å±è”½</h3>
                                <div class="number">${stats.blocked || 0}</div>
                            </div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>è¯·æ±‚æ—¶é—´</th>
                                    <th>è¯·æ±‚è€…</th>
                                    <th>æ¥æ”¶è€…</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å¤„ç†æ—¶é—´</th>
                                    <th>ç•™è¨€</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${friendRequests.map(request => `
                                    <tr>
                                        <td>${new Date(request.created_at).toLocaleString()}</td>
                                        <td>${request.requester_username} (${request.requester_uid})</td>
                                        <td>${request.addressee_username} (${request.addressee_uid})</td>
                                        <td><span class="status-${request.status}">${getFriendStatusText(request.status)}</span></td>
                                        <td>${request.updated_at ? new Date(request.updated_at).toLocaleString() : '-'}</td>
                                        <td>${request.message || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½å¥½å‹è¯·æ±‚å¤±è´¥:', error);
            }
        }

        // åŠ è½½èŠå¤©æ¶ˆæ¯æ•°æ®
        async function loadChatMessages() {
            const conversationType = document.getElementById('chatTypeFilter').value;
            const days = document.getElementById('chatDaysFilter').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/recent-chat-messages?conversationType=${conversationType}&days=${days}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('chatMonitoringContainer');
                    const messages = data.data.messages;
                    const stats = data.data.stats;
                    
                    container.innerHTML = `
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <h3>ç§èŠæ¶ˆæ¯</h3>
                                <div class="number">${stats.private || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>ç¾¤èŠæ¶ˆæ¯</h3>
                                <div class="number">${stats.group || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>AIèŠå¤©</h3>
                                <div class="number">${stats.ai || 0}</div>
                            </div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>æ—¶é—´</th>
                                    <th>å‘é€è€…</th>
                                    <th>ç±»å‹</th>
                                    <th>æ¶ˆæ¯å†…å®¹</th>
                                    <th>æ¶ˆæ¯ç±»å‹</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${messages.map(message => `
                                    <tr>
                                        <td>${new Date(message.created_at).toLocaleString()}</td>
                                        <td>${message.sender_username || message.sender_nickname} (${message.sender_uid})</td>
                                        <td>${getConversationTypeText(message.conversation_type)}</td>
                                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${message.content}">${message.content}</td>
                                        <td>${message.message_type}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('åŠ è½½èŠå¤©æ¶ˆæ¯å¤±è´¥:', error);
            }
        }

        // è¾…åŠ©å‡½æ•°
        function getActivityTypeText(type) {
            const types = {
                'login': 'ç™»å½•',
                'friendship': 'å¥½å‹',
                'message': 'æ¶ˆæ¯'
            };
            return types[type] || type;
        }

        function getFriendStatusText(status) {
            const statuses = {
                'pending': 'å¾…å¤„ç†',
                'accepted': 'å·²æ¥å—', 
                'declined': 'å·²æ‹’ç»',
                'blocked': 'å·²å±è”½'
            };
            return statuses[status] || status;
        }

        function getConversationTypeText(type) {
            const types = {
                'private': 'ç§èŠ',
                'group': 'ç¾¤èŠ',
                'ai': 'AIèŠå¤©'
            };
            return types[type] || type;
        }

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 5000);
        }

        // åŠ è½½ç³»ç»Ÿæ—¥å¿—
        async function loadSystemLogs() {
            try {
                const level = document.getElementById('logLevelFilter').value;
                const category = document.getElementById('logCategoryFilter').value;
                const search = document.getElementById('logSearchInput').value;
                
                const params = new URLSearchParams();
                if (level) params.append('level', level);
                if (category) params.append('category', category);
                if (search) params.append('search', search);
                params.append('limit', '200');
                
                const response = await apiCall(`${API_BASE}/admin/detailed-logs?${params.toString()}`);
                
                if (response.success) {
                    displaySystemLogs(response.data);
                } else {
                    alert('è·å–ç³»ç»Ÿæ—¥å¿—å¤±è´¥: ' + response.message);
                }
            } catch (error) {
                console.error('è·å–ç³»ç»Ÿæ—¥å¿—é”™è¯¯:', error);
                alert('è·å–ç³»ç»Ÿæ—¥å¿—å¤±è´¥: ' + error.message);
            }
        }

        // æ˜¾ç¤ºç³»ç»Ÿæ—¥å¿—
        function displaySystemLogs(data) {
            const { logs, stats, filters } = data;
            
            // æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
            const statsContainer = document.getElementById('logStats');
            statsContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div><strong>æ€»æ—¥å¿—æ•°:</strong> ${stats.total}</div>
                    <div><strong>é”™è¯¯:</strong> <span style="color: #dc3545;">${stats.byLevel.ERROR || 0}</span></div>
                    <div><strong>è­¦å‘Š:</strong> <span style="color: #ffc107;">${stats.byLevel.WARN || 0}</span></div>
                    <div><strong>ä¿¡æ¯:</strong> <span style="color: #28a745;">${stats.byLevel.INFO || 0}</span></div>
                    <div><strong>è°ƒè¯•:</strong> <span style="color: #6c757d;">${stats.byLevel.DEBUG || 0}</span></div>
                    <div><strong>æœ€è¿‘1å°æ—¶é”™è¯¯:</strong> <span style="color: #dc3545;">${stats.recentErrors}</span></div>
                    <div><strong>æœ€è¿‘1å°æ—¶è­¦å‘Š:</strong> <span style="color: #ffc107;">${stats.recentWarnings}</span></div>
                </div>
            `;
            
            // æ˜¾ç¤ºæ—¥å¿—
            const logsContainer = document.getElementById('systemLogsContainer');
            if (logs.length === 0) {
                logsContainer.innerHTML = '<div style="color: #888;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ—¥å¿—</div>';
                return;
            }
            
            let logsHtml = '';
            logs.forEach(log => {
                const levelColor = getLevelColor(log.level);
                const timestamp = new Date(log.timestamp).toLocaleString();
                const dataStr = log.data ? JSON.stringify(log.data, null, 2) : '';
                
                logsHtml += `
                    <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid ${levelColor}; background: #111;">
                        <div style="color: ${levelColor}; font-weight: bold;">
                            [${timestamp}] [${log.level}] [${log.category}]
                        </div>
                        <div style="color: #fff; margin: 5px 0;">
                            ${log.message}
                        </div>
                        ${dataStr ? `<div style="color: #888; font-size: 11px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${dataStr}</div>` : ''}
                    </div>
                `;
            });
            
            logsContainer.innerHTML = logsHtml;
            logsContainer.scrollTop = 0; // æ»šåŠ¨åˆ°é¡¶éƒ¨
        }

        // è·å–æ—¥å¿—çº§åˆ«é¢œè‰²
        function getLevelColor(level) {
            switch (level) {
                case 'ERROR': return '#dc3545';
                case 'WARN': return '#ffc107';
                case 'INFO': return '#28a745';
                case 'DEBUG': return '#6c757d';
                default: return '#fff';
            }
        }

        // æ¸…ç©ºå†…å­˜æ—¥å¿—
        async function clearMemoryLogs() {
            if (!confirm('ç¡®è®¤è¦æ¸…ç©ºå†…å­˜æ—¥å¿—å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            try {
                const response = await apiCall(`${API_BASE}/admin/logs/clear`, {
                    method: 'POST'
                });
                
                if (response.success) {
                    alert('å†…å­˜æ—¥å¿—å·²æ¸…ç©º');
                    loadSystemLogs(); // é‡æ–°åŠ è½½æ—¥å¿—
                } else {
                    alert('æ¸…ç©ºæ—¥å¿—å¤±è´¥: ' + response.message);
                }
            } catch (error) {
                console.error('æ¸…ç©ºæ—¥å¿—é”™è¯¯:', error);
                alert('æ¸…ç©ºæ—¥å¿—å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½æ•°æ®åº“è°ƒè¯•ä¿¡æ¯
        async function loadDatabaseDebugInfo() {
            try {
                const response = await apiCall(`${API_BASE}/admin/debug/database`);
                
                if (response.success) {
                    displayDatabaseDebugInfo(response.data);
                } else {
                    alert('è·å–æ•°æ®åº“è°ƒè¯•ä¿¡æ¯å¤±è´¥: ' + response.message);
                }
            } catch (error) {
                console.error('è·å–æ•°æ®åº“è°ƒè¯•ä¿¡æ¯é”™è¯¯:', error);
                alert('è·å–æ•°æ®åº“è°ƒè¯•ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }

        // åˆ·æ–°æ•°æ®åº“è°ƒè¯•ä¿¡æ¯
        function refreshDatabaseDebugInfo() {
            loadDatabaseDebugInfo();
        }

        // æ˜¾ç¤ºæ•°æ®åº“è°ƒè¯•ä¿¡æ¯
        function displayDatabaseDebugInfo(data) {
            const container = document.getElementById('databaseDebugContainer');
            const { userStats, allUsers, friendshipStats, timestamp } = data;
            
            let html = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h3>æ•°æ®æ›´æ–°æ—¶é—´: ${new Date(timestamp).toLocaleString()}</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                        <h4>ç”¨æˆ·ç»Ÿè®¡</h4>
                        <table style="width: 100%;">
                            <tr><td>æ€»ç”¨æˆ·æ•°:</td><td><strong>${userStats.total_users}</strong></td></tr>
                            <tr><td>æ´»è·ƒç”¨æˆ·:</td><td><strong style="color: #28a745;">${userStats.active_users}</strong></td></tr>
                            <tr><td>æœ€å°ID:</td><td>${userStats.min_id}</td></tr>
                            <tr><td>æœ€å¤§ID:</td><td>${userStats.max_id}</td></tr>
                            <tr><td>æœ€å°UID:</td><td>${userStats.min_uid}</td></tr>
                            <tr><td>æœ€å¤§UID:</td><td>${userStats.max_uid}</td></tr>
                        </table>
                    </div>
                    
                    <div style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                        <h4>å¥½å‹å…³ç³»ç»Ÿè®¡</h4>
                        <table style="width: 100%;">
                            <tr><td>æ€»å¥½å‹å…³ç³»:</td><td><strong>${friendshipStats.total_friendships}</strong></td></tr>
                            <tr><td>å·²æ¥å—:</td><td><strong style="color: #28a745;">${friendshipStats.accepted}</strong></td></tr>
                            <tr><td>å¾…å¤„ç†:</td><td><strong style="color: #ffc107;">${friendshipStats.pending}</strong></td></tr>
                            <tr><td>å·²æ‹’ç»:</td><td><strong style="color: #dc3545;">${friendshipStats.declined}</strong></td></tr>
                        </table>
                    </div>
                </div>
                
                <div style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                    <h4>æ‰€æœ‰ç”¨æˆ·åˆ—è¡¨ (æœ€å¤š50ä¸ª)</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">ID</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">UID</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">ç”¨æˆ·å</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">çŠ¶æ€</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">åˆ›å»ºæ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            allUsers.forEach(user => {
                const statusColor = user.is_active ? '#28a745' : '#dc3545';
                const statusText = user.is_active ? 'æ´»è·ƒ' : 'ç¦ç”¨';
                const createdAt = new Date(user.created_at).toLocaleString();
                
                html += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${user.id}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><strong>${user.uid}</strong></td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${user.username}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; color: ${statusColor};">${statusText}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; font-size: 12px;">${createdAt}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>