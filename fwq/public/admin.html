<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>习惯追踪 - 管理后台</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .nav {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }
        .nav button {
            margin-right: 10px;
            padding: 8px 16px;
            border: none;
            background: #007bff;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
        .nav button:hover {
            background: #0056b3;
        }
        .nav button.active {
            background: #28a745;
        }
        .content {
            padding: 20px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .login-form {
            max-width: 400px;
            margin: 50px auto;
            padding: 30px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        .btn-primary {
            background: #007bff;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #007bff;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
        .ai-character-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status-pending {
            color: #ffc107;
            font-weight: bold;
        }
        .status-accepted {
            color: #28a745;
            font-weight: bold;
        }
        .status-declined {
            color: #dc3545;
            font-weight: bold;
        }
        .status-blocked {
            color: #6c757d;
            font-weight: bold;
        }
        .activity-filters {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        .activity-filters select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
        }
        
        /* 模态框样式 */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .close {
            position: absolute;
            right: 15px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        .close:hover {
            color: black;
        }
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
    </style>
</head>
<body>
    <div id="adminPanel" class="container">
        <div class="header">
            <h1>习惯追踪 - 管理后台</h1>
            <p>系统管理与监控面板</p>
            <button class="btn btn-danger" onclick="logout()" style="position: absolute; top: 20px; right: 20px;">登出</button>
        </div>

        <div class="nav">
            <button class="nav-btn active" onclick="showSection('dashboard')">仪表板</button>
            <button class="nav-btn" onclick="showSection('users')">用户管理</button>
            <button class="nav-btn" onclick="showSection('user-activities')">用户活动</button>
            <button class="nav-btn" onclick="showSection('friend-requests')">好友管理</button>
            <button class="nav-btn" onclick="showSection('chat-monitoring')">聊天监控</button>
            <button class="nav-btn" onclick="showSection('ai-characters')">AI角色管理</button>
            <button class="nav-btn" onclick="showSection('api-test')">API测试</button>
            <button class="nav-btn" onclick="showSection('system-logs')" style="background: #dc3545;">📋 系统日志</button>
            <button class="nav-btn" onclick="showSection('database-debug')" style="background: #6f42c1;">🗄️ 数据库调试</button>
            <button class="nav-btn" onclick="window.open('/ai-chat.html', '_blank')" style="background: #28a745;">🤖 AI聊天</button>
            <button class="nav-btn" onclick="window.open('/admin-debug.html', '_blank')" style="background: #17a2b8;">🔍 调试面板</button>
            <button class="nav-btn" onclick="window.open('/admin-perf-test.html', '_blank')" style="background: #ffc107; color: #000;">⚡ 性能测试</button>
        </div>

        <div class="content">
            <!-- 仪表板 -->
            <div id="dashboard" class="section active">
                <h2>系统概览</h2>
                <div id="statsContainer" class="stats-grid">
                    <!-- 统计数据将在这里显示 -->
                </div>
            </div>

            <!-- 用户管理 -->
            <div id="users" class="section">
                <h2>用户管理</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px; align-items: center;">
                    <input type="text" id="userSearch" placeholder="搜索用户（用户名、邮箱、UID）" onkeyup="searchUsers()" style="max-width: 300px;">
                    <button class="btn btn-success" onclick="showCreateUserModal()">创建用户</button>
                    <button class="btn btn-primary" onclick="loadUsers()">刷新</button>
                </div>
                <div id="usersContainer">
                    <!-- 用户列表将在这里显示 -->
                </div>
            </div>

            <!-- 用户活动 -->
            <div id="user-activities" class="section">
                <h2>用户活动监控</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="activityTypeFilter" onchange="loadUserActivities()">
                        <option value="all">所有活动</option>
                        <option value="login">登录活动</option>
                        <option value="friendship">好友活动</option>
                        <option value="message">消息活动</option>
                    </select>
                    <select id="activityDaysFilter" onchange="loadUserActivities()">
                        <option value="7">最近7天</option>
                        <option value="30">最近30天</option>
                        <option value="90">最近90天</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadUserActivities()">刷新</button>
                </div>
                <div id="userActivitiesContainer">
                    <!-- 用户活动列表将在这里显示 -->
                </div>
            </div>

            <!-- 好友管理 -->
            <div id="friend-requests" class="section">
                <h2>好友请求管理</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="friendStatusFilter" onchange="loadFriendRequests()">
                        <option value="all">全部状态</option>
                        <option value="pending">待处理</option>
                        <option value="accepted">已接受</option>
                        <option value="declined">已拒绝</option>
                        <option value="blocked">已屏蔽</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadFriendRequests()">刷新</button>
                </div>
                <div id="friendRequestsContainer">
                    <!-- 好友请求列表将在这里显示 -->
                </div>
            </div>

            <!-- 聊天监控 -->
            <div id="chat-monitoring" class="section">
                <h2>聊天消息监控</h2>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <select id="chatTypeFilter" onchange="loadChatMessages()">
                        <option value="all">所有消息</option>
                        <option value="private">私聊</option>
                        <option value="group">群聊</option>
                        <option value="ai">AI聊天</option>
                    </select>
                    <select id="chatDaysFilter" onchange="loadChatMessages()">
                        <option value="7">最近7天</option>
                        <option value="30">最近30天</option>
                        <option value="90">最近90天</option>
                    </select>
                    <button class="btn btn-primary" onclick="loadChatMessages()">刷新</button>
                </div>
                <div id="chatMonitoringContainer">
                    <!-- 聊天消息列表将在这里显示 -->
                </div>
            </div>

            <!-- AI角色管理 -->
            <div id="ai-characters" class="section">
                <h2>AI角色管理</h2>
                
                <div class="ai-character-form">
                    <h3>创建新AI角色</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>角色名称:</label>
                            <input type="text" id="characterName" placeholder="例如：学习助手">
                        </div>
                        <div class="form-group">
                            <label>AI模型:</label>
                            <select id="characterModel">
                                <option value="gpt-4.1">GPT-4.1 (推荐)</option>
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>角色描述:</label>
                        <input type="text" id="characterDescription" placeholder="简短描述这个AI角色的用途">
                    </div>
                    <div class="form-group">
                        <label>角色性格:</label>
                        <input type="text" id="characterPersonality" placeholder="例如：友善、专业、耐心">
                    </div>
                    <div class="form-group">
                        <label>系统提示词:</label>
                        <textarea id="characterSystemPrompt" rows="4" placeholder="详细描述AI角色的行为和回应方式..."></textarea>
                    </div>
                    <button class="btn btn-success" onclick="createAICharacter()">创建角色</button>
                </div>

                <div id="aiCharactersContainer">
                    <!-- AI角色列表将在这里显示 -->
                </div>
            </div>

            <!-- API测试 -->
            <div id="api-test" class="section">
                <h2>API测试工具</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3>测试用户注册</h3>
                        <div class="form-group">
                            <label>用户名:</label>
                            <input type="text" id="testUsername" value="testuser">
                        </div>
                        <div class="form-group">
                            <label>邮箱:</label>
                            <input type="email" id="testEmail" value="test@example.com">
                        </div>
                        <div class="form-group">
                            <label>密码:</label>
                            <input type="password" id="testPassword" value="password123">
                        </div>
                        <div class="form-group">
                            <label>昵称:</label>
                            <input type="text" id="testNickname" value="测试用户">
                        </div>
                        <button class="btn btn-primary" onclick="testRegister()">测试注册</button>
                    </div>
                    <div>
                        <h3>测试AI聊天</h3>
                        <div class="form-group">
                            <label>选择AI角色:</label>
                            <select id="testAICharacter">
                                <!-- AI角色选项将动态加载 -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label>测试消息:</label>
                            <textarea id="testMessage" rows="3">你好，请介绍一下自己</textarea>
                        </div>
                        <button class="btn btn-primary" onclick="testAIChat()">发送消息</button>
                    </div>
                </div>
                <div id="testResults" style="margin-top: 20px;">
                    <!-- 测试结果将在这里显示 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 创建用户模态框 -->
    <div id="createUserModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="hideCreateUserModal()">&times;</span>
            <h2>创建新用户</h2>
            <form id="createUserForm" style="max-width: 400px;">
                <div class="form-group">
                    <label>用户名 *</label>
                    <input type="text" id="newUsername" required placeholder="请输入用户名">
                </div>
                <div class="form-group">
                    <label>邮箱 *</label>
                    <input type="email" id="newEmail" required placeholder="请输入邮箱">
                </div>
                <div class="form-group">
                    <label>密码 *</label>
                    <input type="password" id="newPassword" required placeholder="请输入密码">
                </div>
                <div class="form-group">
                    <label>昵称</label>
                    <input type="text" id="newNickname" placeholder="请输入昵称">
                </div>
                <div class="form-group">
                    <label>角色</label>
                    <select id="newRole">
                        <option value="user">普通用户</option>
                        <option value="admin">管理员</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateUserModal()">取消</button>
                    <button type="submit" class="btn btn-success">创建用户</button>
                </div>
            </form>
            <!-- 系统日志管理 -->
            <div id="system-logs" class="section">
                <h2>系统日志管理</h2>
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <label>日志级别:</label>
                        <select id="logLevelFilter" style="padding: 5px;">
                            <option value="">全部</option>
                            <option value="ERROR">错误</option>
                            <option value="WARN">警告</option>
                            <option value="INFO">信息</option>
                            <option value="DEBUG">调试</option>
                        </select>
                        
                        <label>分类:</label>
                        <select id="logCategoryFilter" style="padding: 5px;">
                            <option value="">全部</option>
                            <option value="USER_SEARCH">用户搜索</option>
                            <option value="ADMIN_LOGS">管理员日志</option>
                            <option value="ADMIN_DEBUG">调试信息</option>
                            <option value="SYSTEM">系统</option>
                        </select>
                        
                        <label>搜索:</label>
                        <input type="text" id="logSearchInput" placeholder="搜索日志内容..." style="padding: 5px; width: 200px;">
                        
                        <button class="btn btn-primary" onclick="loadSystemLogs()">刷新日志</button>
                        <button class="btn btn-warning" onclick="clearMemoryLogs()">清空内存日志</button>
                    </div>
                </div>
                
                <div id="logStats" style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <!-- 日志统计信息将在这里显示 -->
                </div>
                
                <div id="systemLogsContainer" style="max-height: 600px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #000; color: #fff; font-family: 'Courier New', monospace; font-size: 12px;">
                    <div style="color: #888;">正在加载系统日志...</div>
                </div>
            </div>

            <!-- 数据库调试信息 -->
            <div id="database-debug" class="section">
                <h2>数据库调试信息</h2>
                <div style="margin-bottom: 20px;">
                    <button class="btn btn-primary" onclick="loadDatabaseDebugInfo()">获取数据库信息</button>
                    <button class="btn btn-info" onclick="refreshDatabaseDebugInfo()">刷新</button>
                </div>
                
                <div id="databaseDebugContainer">
                    <div style="color: #888;">点击上方按钮获取数据库调试信息...</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // 登录状态检查 - 页面加载时立即执行
        (function() {
            const token = localStorage.getItem('adminToken');
            const user = localStorage.getItem('adminUser');
            
            if (!token || !user) {
                // 未登录，跳转到登录页面
                window.location.href = '/';
                return;
            }
            
            try {
                const userData = JSON.parse(user);
                if (userData.role !== 'admin') {
                    // 不是管理员，清除数据并跳转
                    localStorage.removeItem('adminToken');
                    localStorage.removeItem('adminRefreshToken');
                    localStorage.removeItem('adminUser');
                    window.location.href = '/';
                    return;
                }
            } catch (e) {
                // 数据无效，清除并跳转
                localStorage.removeItem('adminToken');
                localStorage.removeItem('adminRefreshToken');
                localStorage.removeItem('adminUser');
                window.location.href = '/';
                return;
            }
        })();

        // 使用当前协议（支持HTTP和HTTPS）
        const API_BASE = window.location.origin + '/api';
        
        console.log('API地址:', API_BASE);
        let accessToken = localStorage.getItem('adminToken');

        // 通用API调用函数
        async function apiCall(url, options = {}) {
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(accessToken && { 'Authorization': `Bearer ${accessToken}` })
                }
            };
            
            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: { ...defaultOptions.headers, ...options.headers }
            };
            
            console.log('API调用:', url, 'Token:', accessToken ? accessToken.substring(0, 20) + '...' : 'null');
            
            const response = await fetch(url, finalOptions);
            
            if (!response.ok) {
                if (response.status === 401) {
                    console.error('认证失败，重新登录');
                    logout();
                    throw new Error('认证失败，请重新登录');
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            return response.json();
        }

        // 页面加载时检查登录状态和绑定事件
        window.onload = function() {
            // 先检查API连接
            checkAPIConnection();
            
            // 直接显示管理面板（登录检查已在页面开头完成）
            showAdminPanel();
            
            // 添加表单事件监听器
            document.getElementById('createUserForm').addEventListener('submit', createUser);
        };

        // 检查API连接
        async function checkAPIConnection() {
            try {
                const healthUrl = window.location.origin + '/health';
                console.log('检查API连接:', healthUrl);
                
                const response = await fetch(healthUrl);
                if (response.ok) {
                    const data = await response.json();
                    console.log('✅ API连接成功:', data);
                } else {
                    console.error('❌ API连接失败:', response.status);
                    showError('loginError', `API服务器响应错误: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ API连接检查失败:', error);
                showError('loginError', 'API服务器连接失败，请检查服务器状态');
            }
        }



        // 登出函数
        function logout() {
            localStorage.removeItem('adminToken');
            localStorage.removeItem('adminRefreshToken');
            localStorage.removeItem('adminUser');
            accessToken = null;
            window.location.href = '/';
        }

        // 显示管理面板
        function showAdminPanel() {
            // 管理面板已经可见，直接加载数据
            loadDashboard();
        }

        // 切换页面
        function showSection(sectionName) {
            // 隐藏所有section
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            // 显示选中的section
            document.getElementById(sectionName).classList.add('active');
            event.target.classList.add('active');

            // 加载对应数据
            switch(sectionName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'user-activities':
                    loadUserActivities();
                    break;
                case 'friend-requests':
                    loadFriendRequests();
                    break;
                case 'chat-monitoring':
                    loadChatMessages();
                    break;
                case 'ai-characters':
                    loadAICharacters();
                    break;
                case 'api-test':
                    loadAICharactersForTest();
                    break;
            }
        }

        // 加载仪表板数据
        async function loadDashboard() {
            try {
                const response = await fetch(`${API_BASE}/admin/stats`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const stats = data.data;
                    const container = document.getElementById('statsContainer');
                    container.innerHTML = `
                        <div class="stat-card">
                            <h3>总用户数</h3>
                            <div class="number">${stats.users.total_users}</div>
                        </div>
                        <div class="stat-card">
                            <h3>活跃用户</h3>
                            <div class="number">${stats.users.active_users}</div>
                        </div>
                        <div class="stat-card">
                            <h3>本周新用户</h3>
                            <div class="number">${stats.users.new_users_week}</div>
                        </div>
                        <div class="stat-card">
                            <h3>今日登录</h3>
                            <div class="number">${stats.users.logins_today || 0}</div>
                        </div>
                        <div class="stat-card">
                            <h3>总消息数</h3>
                            <div class="number">${stats.messages.total_messages}</div>
                        </div>
                        <div class="stat-card">
                            <h3>今日消息</h3>
                            <div class="number">${stats.messages.messages_today}</div>
                        </div>
                        <div class="stat-card">
                            <h3>待处理好友请求</h3>
                            <div class="number">${stats.friendRequests?.pending || 0}</div>
                        </div>
                        <div class="stat-card">
                            <h3>AI角色数</h3>
                            <div class="number">${stats.aiCharacters.active_characters}</div>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('加载统计数据失败:', error);
            }
        }

        // 加载用户列表
        async function loadUsers() {
            try {
                const data = await apiCall(`${API_BASE}/admin/users`);

                if (data.success) {
                    const container = document.getElementById('usersContainer');
                    const users = data.data.users;
                    
                    container.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>UID</th>
                                    <th>用户名</th>
                                    <th>邮箱</th>
                                    <th>昵称</th>
                                    <th>角色</th>
                                    <th>状态</th>
                                    <th>注册时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${users.map(user => `
                                    <tr>
                                        <td>${user.uid}</td>
                                        <td>${user.username}</td>
                                        <td>${user.email}</td>
                                        <td>${user.nickname || '-'}</td>
                                        <td>${user.role}</td>
                                        <td>${user.is_active ? '活跃' : '禁用'}</td>
                                        <td>${new Date(user.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <button class="btn ${user.is_active ? 'btn-danger' : 'btn-success'}" 
                                                    onclick="toggleUserStatus(${user.id}, ${!user.is_active})">
                                                ${user.is_active ? '禁用' : '启用'}
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('加载用户列表失败:', error);
            }
        }

        // 搜索用户
        async function searchUsers() {
            const search = document.getElementById('userSearch').value;
            if (search.length < 2) return;

            try {
                const response = await fetch(`${API_BASE}/admin/users?search=${encodeURIComponent(search)}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    // 更新用户列表显示
                    loadUsers();
                }
            } catch (error) {
                console.error('搜索用户失败:', error);
            }
        }

        // 切换用户状态
        async function toggleUserStatus(userId, isActive) {
            try {
                const response = await fetch(`${API_BASE}/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive })
                });

                const data = await response.json();
                if (data.success) {
                    loadUsers(); // 重新加载用户列表
                }
            } catch (error) {
                console.error('更新用户状态失败:', error);
            }
        }

        // 显示创建用户模态框
        function showCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'flex';
        }

        // 隐藏创建用户模态框
        function hideCreateUserModal() {
            document.getElementById('createUserModal').style.display = 'none';
            document.getElementById('createUserForm').reset();
        }

        // 创建用户
        async function createUser(event) {
            event.preventDefault();
            
            const username = document.getElementById('newUsername').value;
            const email = document.getElementById('newEmail').value;
            const password = document.getElementById('newPassword').value;
            const nickname = document.getElementById('newNickname').value;
            const role = document.getElementById('newRole').value;

            try {
                const response = await fetch(`${API_BASE}/admin/users`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        email,
                        password,
                        nickname: nickname || username,
                        role
                    })
                });

                const data = await response.json();
                if (data.success) {
                    alert('用户创建成功！');
                    hideCreateUserModal();
                    loadUsers(); // 重新加载用户列表
                } else {
                    alert('创建失败：' + data.message);
                }
            } catch (error) {
                console.error('创建用户失败:', error);
                alert('创建用户失败，请重试');
            }
        }

        // 加载AI角色
        async function loadAICharacters() {
            try {
                const response = await fetch(`${API_BASE}/ai-characters/admin/all`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('aiCharactersContainer');
                    const characters = data.data;
                    
                    container.innerHTML = `
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>名称</th>
                                    <th>描述</th>
                                    <th>模型</th>
                                    <th>状态</th>
                                    <th>创建时间</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${characters.map(char => `
                                    <tr>
                                        <td>${char.name}</td>
                                        <td>${char.description || '-'}</td>
                                        <td>${char.model}</td>
                                        <td>${char.is_active ? '活跃' : '禁用'}</td>
                                        <td>${new Date(char.created_at).toLocaleDateString()}</td>
                                        <td>
                                            <button class="btn btn-primary" 
                                                    onclick="editAICharacter('${char.character_id}')">
                                                编辑
                                            </button>
                                            <button class="btn ${char.is_active ? 'btn-danger' : 'btn-success'}" 
                                                    onclick="toggleCharacterStatus('${char.character_id}', ${!char.is_active})">
                                                ${char.is_active ? '禁用' : '启用'}
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('加载AI角色失败:', error);
            }
        }

        // 创建AI角色
        async function createAICharacter() {
            const characterData = {
                name: document.getElementById('characterName').value,
                description: document.getElementById('characterDescription').value,
                personality: document.getElementById('characterPersonality').value,
                systemPrompt: document.getElementById('characterSystemPrompt').value,
                model: document.getElementById('characterModel').value
            };

            try {
                const response = await fetch(`${API_BASE}/ai-characters`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(characterData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('AI角色创建成功！');
                    // 清空表单
                    document.getElementById('characterName').value = '';
                    document.getElementById('characterDescription').value = '';
                    document.getElementById('characterPersonality').value = '';
                    document.getElementById('characterSystemPrompt').value = '';
                    // 重新加载列表
                    loadAICharacters();
                } else {
                    alert('创建失败：' + data.message);
                }
            } catch (error) {
                alert('创建失败：' + error.message);
            }
        }

        // 编辑AI角色
        async function editAICharacter(characterId) {
            try {
                // 获取角色详情
                const response = await fetch(`${API_BASE}/ai-characters/admin/${characterId}`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const char = data.data;
                    
                    // 填充表单
                    document.getElementById('characterName').value = char.name;
                    document.getElementById('characterDescription').value = char.description || '';
                    document.getElementById('characterPersonality').value = char.personality || '';
                    document.getElementById('characterSystemPrompt').value = char.system_prompt || '';
                    document.getElementById('characterModel').value = char.model;

                    // 修改按钮文本和行为
                    const createBtn = document.querySelector('.ai-character-form button');
                    createBtn.textContent = '更新角色';
                    createBtn.setAttribute('onclick', `updateAICharacter('${characterId}')`);
                }
            } catch (error) {
                console.error('获取AI角色详情失败:', error);
                alert('获取角色信息失败: ' + error.message);
            }
        }

        // 更新AI角色
        async function updateAICharacter(characterId) {
            const characterData = {
                name: document.getElementById('characterName').value,
                description: document.getElementById('characterDescription').value,
                personality: document.getElementById('characterPersonality').value,
                systemPrompt: document.getElementById('characterSystemPrompt').value,
                model: document.getElementById('characterModel').value
            };

            try {
                const response = await fetch(`${API_BASE}/ai-characters/${characterId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(characterData)
                });

                const data = await response.json();
                if (data.success) {
                    alert('AI角色更新成功！');
                    // 重置表单
                    resetCharacterForm();
                    // 重新加载列表
                    loadAICharacters();
                } else {
                    alert('更新失败：' + data.message);
                }
            } catch (error) {
                alert('更新失败：' + error.message);
            }
        }

        // 重置角色表单
        function resetCharacterForm() {
            document.getElementById('characterName').value = '';
            document.getElementById('characterDescription').value = '';
            document.getElementById('characterPersonality').value = '';
            document.getElementById('characterSystemPrompt').value = '';
            document.getElementById('characterModel').value = 'gpt-4.1';
            
            // 重置按钮
            const createBtn = document.querySelector('.ai-character-form button');
            createBtn.textContent = '创建角色';
            createBtn.setAttribute('onclick', 'createAICharacter()');
        }

        // 切换AI角色状态
        async function toggleCharacterStatus(characterId, isActive) {
            try {
                const response = await fetch(`${API_BASE}/ai-characters/${characterId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive })
                });

                const data = await response.json();
                if (data.success) {
                    loadAICharacters();
                }
            } catch (error) {
                console.error('更新AI角色状态失败:', error);
            }
        }

        // 为测试加载AI角色
        async function loadAICharactersForTest() {
            try {
                const response = await fetch(`${API_BASE}/ai-characters`);
                const data = await response.json();

                if (data.success) {
                    const select = document.getElementById('testAICharacter');
                    select.innerHTML = data.data.map(char => 
                        `<option value="${char.character_id}">${char.name}</option>`
                    ).join('');
                }
            } catch (error) {
                console.error('加载AI角色失败:', error);
            }
        }

        // 测试用户注册
        async function testRegister() {
            const userData = {
                username: document.getElementById('testUsername').value,
                email: document.getElementById('testEmail').value,
                password: document.getElementById('testPassword').value,
                confirmPassword: document.getElementById('testPassword').value,
                nickname: document.getElementById('testNickname').value
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });

                const data = await response.json();
                showTestResult('注册测试', data);
            } catch (error) {
                showTestResult('注册测试', { success: false, message: error.message });
            }
        }

        // 测试AI聊天
        async function testAIChat() {
            const characterId = document.getElementById('testAICharacter').value;
            const message = document.getElementById('testMessage').value;

            try {
                const response = await fetch(`${API_BASE}/chat/ai/chat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ characterId, message })
                });

                const data = await response.json();
                showTestResult('AI聊天测试', data);
            } catch (error) {
                showTestResult('AI聊天测试', { success: false, message: error.message });
            }
        }

        // 显示测试结果
        function showTestResult(testName, result) {
            const container = document.getElementById('testResults');
            const div = document.createElement('div');
            div.className = `alert ${result.success ? 'alert-success' : 'alert-error'}`;
            div.innerHTML = `
                <h4>${testName}</h4>
                <pre>${JSON.stringify(result, null, 2)}</pre>
            `;
            container.appendChild(div);
        }

        // 加载用户活动数据
        async function loadUserActivities() {
            const activityType = document.getElementById('activityTypeFilter').value;
            const days = document.getElementById('activityDaysFilter').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/user-activity-logs?activityType=${activityType}&days=${days}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('userActivitiesContainer');
                    const activities = data.data.activities;
                    const stats = data.data.stats;
                    
                    container.innerHTML = `
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <h3>登录活动</h3>
                                <div class="number">${stats.login || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>好友活动</h3>
                                <div class="number">${stats.friendship || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>消息活动</h3>
                                <div class="number">${stats.message || 0}</div>
                            </div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>用户</th>
                                    <th>活动类型</th>
                                    <th>详情</th>
                                    <th>IP地址</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${activities.map(activity => `
                                    <tr>
                                        <td>${new Date(activity.created_at).toLocaleString()}</td>
                                        <td>${activity.username || activity.nickname || activity.uid}</td>
                                        <td>${getActivityTypeText(activity.activity_type)}</td>
                                        <td>${activity.activity_details}</td>
                                        <td>${activity.ip_address || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('加载用户活动失败:', error);
            }
        }

        // 加载好友请求数据
        async function loadFriendRequests() {
            const status = document.getElementById('friendStatusFilter').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/friend-requests?status=${status}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('friendRequestsContainer');
                    const friendRequests = data.data.friendRequests;
                    const stats = data.data.stats;
                    
                    container.innerHTML = `
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <h3>待处理</h3>
                                <div class="number">${stats.pending || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>已接受</h3>
                                <div class="number">${stats.accepted || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>已拒绝</h3>
                                <div class="number">${stats.declined || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>已屏蔽</h3>
                                <div class="number">${stats.blocked || 0}</div>
                            </div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>请求时间</th>
                                    <th>请求者</th>
                                    <th>接收者</th>
                                    <th>状态</th>
                                    <th>处理时间</th>
                                    <th>留言</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${friendRequests.map(request => `
                                    <tr>
                                        <td>${new Date(request.created_at).toLocaleString()}</td>
                                        <td>${request.requester_username} (${request.requester_uid})</td>
                                        <td>${request.addressee_username} (${request.addressee_uid})</td>
                                        <td><span class="status-${request.status}">${getFriendStatusText(request.status)}</span></td>
                                        <td>${request.updated_at ? new Date(request.updated_at).toLocaleString() : '-'}</td>
                                        <td>${request.message || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('加载好友请求失败:', error);
            }
        }

        // 加载聊天消息数据
        async function loadChatMessages() {
            const conversationType = document.getElementById('chatTypeFilter').value;
            const days = document.getElementById('chatDaysFilter').value;
            
            try {
                const response = await fetch(`${API_BASE}/admin/recent-chat-messages?conversationType=${conversationType}&days=${days}&limit=50`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    const container = document.getElementById('chatMonitoringContainer');
                    const messages = data.data.messages;
                    const stats = data.data.stats;
                    
                    container.innerHTML = `
                        <div class="stats-grid" style="margin-bottom: 20px;">
                            <div class="stat-card">
                                <h3>私聊消息</h3>
                                <div class="number">${stats.private || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>群聊消息</h3>
                                <div class="number">${stats.group || 0}</div>
                            </div>
                            <div class="stat-card">
                                <h3>AI聊天</h3>
                                <div class="number">${stats.ai || 0}</div>
                            </div>
                        </div>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>时间</th>
                                    <th>发送者</th>
                                    <th>类型</th>
                                    <th>消息内容</th>
                                    <th>消息类型</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${messages.map(message => `
                                    <tr>
                                        <td>${new Date(message.created_at).toLocaleString()}</td>
                                        <td>${message.sender_username || message.sender_nickname} (${message.sender_uid})</td>
                                        <td>${getConversationTypeText(message.conversation_type)}</td>
                                        <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${message.content}">${message.content}</td>
                                        <td>${message.message_type}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                }
            } catch (error) {
                console.error('加载聊天消息失败:', error);
            }
        }

        // 辅助函数
        function getActivityTypeText(type) {
            const types = {
                'login': '登录',
                'friendship': '好友',
                'message': '消息'
            };
            return types[type] || type;
        }

        function getFriendStatusText(status) {
            const statuses = {
                'pending': '待处理',
                'accepted': '已接受', 
                'declined': '已拒绝',
                'blocked': '已屏蔽'
            };
            return statuses[status] || status;
        }

        function getConversationTypeText(type) {
            const types = {
                'private': '私聊',
                'group': '群聊',
                'ai': 'AI聊天'
            };
            return types[type] || type;
        }

        // 显示错误信息
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.classList.remove('hidden');
            setTimeout(() => element.classList.add('hidden'), 5000);
        }

        // 加载系统日志
        async function loadSystemLogs() {
            try {
                const level = document.getElementById('logLevelFilter').value;
                const category = document.getElementById('logCategoryFilter').value;
                const search = document.getElementById('logSearchInput').value;
                
                const params = new URLSearchParams();
                if (level) params.append('level', level);
                if (category) params.append('category', category);
                if (search) params.append('search', search);
                params.append('limit', '200');
                
                const response = await apiCall(`${API_BASE}/admin/detailed-logs?${params.toString()}`);
                
                if (response.success) {
                    displaySystemLogs(response.data);
                } else {
                    alert('获取系统日志失败: ' + response.message);
                }
            } catch (error) {
                console.error('获取系统日志错误:', error);
                alert('获取系统日志失败: ' + error.message);
            }
        }

        // 显示系统日志
        function displaySystemLogs(data) {
            const { logs, stats, filters } = data;
            
            // 显示统计信息
            const statsContainer = document.getElementById('logStats');
            statsContainer.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    <div><strong>总日志数:</strong> ${stats.total}</div>
                    <div><strong>错误:</strong> <span style="color: #dc3545;">${stats.byLevel.ERROR || 0}</span></div>
                    <div><strong>警告:</strong> <span style="color: #ffc107;">${stats.byLevel.WARN || 0}</span></div>
                    <div><strong>信息:</strong> <span style="color: #28a745;">${stats.byLevel.INFO || 0}</span></div>
                    <div><strong>调试:</strong> <span style="color: #6c757d;">${stats.byLevel.DEBUG || 0}</span></div>
                    <div><strong>最近1小时错误:</strong> <span style="color: #dc3545;">${stats.recentErrors}</span></div>
                    <div><strong>最近1小时警告:</strong> <span style="color: #ffc107;">${stats.recentWarnings}</span></div>
                </div>
            `;
            
            // 显示日志
            const logsContainer = document.getElementById('systemLogsContainer');
            if (logs.length === 0) {
                logsContainer.innerHTML = '<div style="color: #888;">没有找到匹配的日志</div>';
                return;
            }
            
            let logsHtml = '';
            logs.forEach(log => {
                const levelColor = getLevelColor(log.level);
                const timestamp = new Date(log.timestamp).toLocaleString();
                const dataStr = log.data ? JSON.stringify(log.data, null, 2) : '';
                
                logsHtml += `
                    <div style="margin-bottom: 10px; padding: 8px; border-left: 3px solid ${levelColor}; background: #111;">
                        <div style="color: ${levelColor}; font-weight: bold;">
                            [${timestamp}] [${log.level}] [${log.category}]
                        </div>
                        <div style="color: #fff; margin: 5px 0;">
                            ${log.message}
                        </div>
                        ${dataStr ? `<div style="color: #888; font-size: 11px; white-space: pre-wrap; max-height: 200px; overflow-y: auto;">${dataStr}</div>` : ''}
                    </div>
                `;
            });
            
            logsContainer.innerHTML = logsHtml;
            logsContainer.scrollTop = 0; // 滚动到顶部
        }

        // 获取日志级别颜色
        function getLevelColor(level) {
            switch (level) {
                case 'ERROR': return '#dc3545';
                case 'WARN': return '#ffc107';
                case 'INFO': return '#28a745';
                case 'DEBUG': return '#6c757d';
                default: return '#fff';
            }
        }

        // 清空内存日志
        async function clearMemoryLogs() {
            if (!confirm('确认要清空内存日志吗？此操作不可恢复。')) {
                return;
            }
            
            try {
                const response = await apiCall(`${API_BASE}/admin/logs/clear`, {
                    method: 'POST'
                });
                
                if (response.success) {
                    alert('内存日志已清空');
                    loadSystemLogs(); // 重新加载日志
                } else {
                    alert('清空日志失败: ' + response.message);
                }
            } catch (error) {
                console.error('清空日志错误:', error);
                alert('清空日志失败: ' + error.message);
            }
        }

        // 加载数据库调试信息
        async function loadDatabaseDebugInfo() {
            try {
                const response = await apiCall(`${API_BASE}/admin/debug/database`);
                
                if (response.success) {
                    displayDatabaseDebugInfo(response.data);
                } else {
                    alert('获取数据库调试信息失败: ' + response.message);
                }
            } catch (error) {
                console.error('获取数据库调试信息错误:', error);
                alert('获取数据库调试信息失败: ' + error.message);
            }
        }

        // 刷新数据库调试信息
        function refreshDatabaseDebugInfo() {
            loadDatabaseDebugInfo();
        }

        // 显示数据库调试信息
        function displayDatabaseDebugInfo(data) {
            const container = document.getElementById('databaseDebugContainer');
            const { userStats, allUsers, friendshipStats, timestamp } = data;
            
            let html = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <h3>数据更新时间: ${new Date(timestamp).toLocaleString()}</h3>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                        <h4>用户统计</h4>
                        <table style="width: 100%;">
                            <tr><td>总用户数:</td><td><strong>${userStats.total_users}</strong></td></tr>
                            <tr><td>活跃用户:</td><td><strong style="color: #28a745;">${userStats.active_users}</strong></td></tr>
                            <tr><td>最小ID:</td><td>${userStats.min_id}</td></tr>
                            <tr><td>最大ID:</td><td>${userStats.max_id}</td></tr>
                            <tr><td>最小UID:</td><td>${userStats.min_uid}</td></tr>
                            <tr><td>最大UID:</td><td>${userStats.max_uid}</td></tr>
                        </table>
                    </div>
                    
                    <div style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                        <h4>好友关系统计</h4>
                        <table style="width: 100%;">
                            <tr><td>总好友关系:</td><td><strong>${friendshipStats.total_friendships}</strong></td></tr>
                            <tr><td>已接受:</td><td><strong style="color: #28a745;">${friendshipStats.accepted}</strong></td></tr>
                            <tr><td>待处理:</td><td><strong style="color: #ffc107;">${friendshipStats.pending}</strong></td></tr>
                            <tr><td>已拒绝:</td><td><strong style="color: #dc3545;">${friendshipStats.declined}</strong></td></tr>
                        </table>
                    </div>
                </div>
                
                <div style="background: #fff; padding: 15px; border: 1px solid #ddd; border-radius: 5px;">
                    <h4>所有用户列表 (最多50个)</h4>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa;">
                                    <th style="border: 1px solid #ddd; padding: 8px;">ID</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">UID</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">用户名</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">状态</th>
                                    <th style="border: 1px solid #ddd; padding: 8px;">创建时间</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            allUsers.forEach(user => {
                const statusColor = user.is_active ? '#28a745' : '#dc3545';
                const statusText = user.is_active ? '活跃' : '禁用';
                const createdAt = new Date(user.created_at).toLocaleString();
                
                html += `
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">${user.id}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; font-family: monospace;"><strong>${user.uid}</strong></td>
                        <td style="border: 1px solid #ddd; padding: 8px;">${user.username}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; color: ${statusColor};">${statusText}</td>
                        <td style="border: 1px solid #ddd; padding: 8px; font-size: 12px;">${createdAt}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>